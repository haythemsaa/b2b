# üìö Documentation Syst√®me d'Int√©grations ERP/Comptabilit√©

## üìã Table des Mati√®res

1. [Vue d'ensemble](#vue-densemble)
2. [Architecture technique](#architecture-technique)
3. [Installation et configuration](#installation-et-configuration)
4. [Guide d'utilisation](#guide-dutilisation)
5. [Impl√©mentation par ERP](#impl√©mentation-par-erp)
6. [API et d√©veloppement](#api-et-d√©veloppement)
7. [S√©curit√©](#s√©curit√©)
8. [Monitoring et logs](#monitoring-et-logs)
9. [D√©pannage](#d√©pannage)

---

## üéØ Vue d'ensemble

### Objectif du syst√®me

Le syst√®me d'int√©grations ERP/Comptabilit√© permet de **synchroniser automatiquement** les donn√©es de la plateforme B2B avec des syst√®mes externes de gestion d'entreprise (ERP) et de comptabilit√©.

### Fonctionnalit√©s principales

- ‚úÖ **8 syst√®mes ERP support√©s** : SAP B1, Dynamics 365, Sage, QuickBooks, Odoo, Xero, NetSuite, Custom API
- ‚úÖ **Synchronisation bidirectionnelle** : Export, Import ou les deux
- ‚úÖ **Entit√©s synchronisables** : Produits, Commandes, Clients, Factures, Inventaire
- ‚úÖ **Planification automatique** : Manuel, Horaire, Quotidien, Hebdomadaire
- ‚úÖ **Mapping d'IDs** : Correspondance automatique entre IDs internes et externes
- ‚úÖ **Logs d√©taill√©s** : Tra√ßabilit√© compl√®te de toutes les op√©rations
- ‚úÖ **S√©curit√© renforc√©e** : Credentials chiffr√©s avec Laravel Crypt
- ‚úÖ **Monitoring temps r√©el** : M√©triques de performance et taux de succ√®s

### Cas d'usage

1. **Export automatique des commandes** vers SAP Business One pour facturation
2. **Import des stocks** depuis Odoo ERP pour mise √† jour inventaire
3. **Synchronisation des clients** avec Microsoft Dynamics 365
4. **Export des factures** vers QuickBooks pour comptabilit√©
5. **Synchronisation bidirectionnelle** produits avec syst√®me custom

---

## üèóÔ∏è Architecture technique

### Structure de base de donn√©es

#### Table `integrations`
Stocke les configurations des int√©grations ERP.

```sql
CREATE TABLE integrations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL,
    name VARCHAR(255) NOT NULL,
    type ENUM('sap_b1', 'dynamics_365', 'sage', 'quickbooks', 'odoo', 'xero', 'netsuite', 'custom_api'),
    status ENUM('active', 'inactive', 'error', 'testing') DEFAULT 'inactive',
    credentials JSON NULL COMMENT 'Encrypted',
    settings JSON NULL,
    sync_direction ENUM('export', 'import', 'bidirectional') DEFAULT 'export',

    -- Options de synchronisation
    sync_products BOOLEAN DEFAULT FALSE,
    sync_orders BOOLEAN DEFAULT TRUE,
    sync_customers BOOLEAN DEFAULT FALSE,
    sync_invoices BOOLEAN DEFAULT TRUE,
    sync_inventory BOOLEAN DEFAULT FALSE,

    -- Planification
    sync_frequency ENUM('manual', 'hourly', 'daily', 'weekly') DEFAULT 'manual',
    last_sync_at TIMESTAMP NULL,
    next_sync_at TIMESTAMP NULL,

    -- Statistiques
    total_syncs INT DEFAULT 0,
    successful_syncs INT DEFAULT 0,
    failed_syncs INT DEFAULT 0,
    last_error TEXT NULL,

    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    deleted_at TIMESTAMP NULL,

    FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE,
    INDEX idx_tenant_status (tenant_id, status)
);
```

#### Table `integration_logs`
Historique d√©taill√© de toutes les synchronisations.

```sql
CREATE TABLE integration_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    integration_id BIGINT NOT NULL,
    tenant_id BIGINT NOT NULL,
    entity_type ENUM('product', 'order', 'customer', 'invoice', 'inventory', 'other'),
    entity_id VARCHAR(255) NULL,
    external_id VARCHAR(255) NULL,
    action ENUM('create', 'update', 'delete', 'sync'),
    direction ENUM('export', 'import'),
    status ENUM('success', 'failed', 'pending', 'partial'),
    request_data JSON NULL,
    response_data JSON NULL,
    error_message TEXT NULL,
    duration_ms INT NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,

    FOREIGN KEY (integration_id) REFERENCES integrations(id) ON DELETE CASCADE,
    INDEX idx_integration_created (integration_id, created_at),
    INDEX idx_status (status)
);
```

#### Table `integration_mappings`
Correspondance entre IDs internes et IDs externes.

```sql
CREATE TABLE integration_mappings (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    integration_id BIGINT NOT NULL,
    tenant_id BIGINT NOT NULL,
    entity_type ENUM('product', 'order', 'customer', 'invoice', 'category', 'other'),
    internal_id VARCHAR(255) NOT NULL,
    external_id VARCHAR(255) NOT NULL,
    metadata JSON NULL,
    last_synced_at TIMESTAMP NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,

    FOREIGN KEY (integration_id) REFERENCES integrations(id) ON DELETE CASCADE,
    UNIQUE KEY unique_internal_mapping (integration_id, entity_type, internal_id),
    UNIQUE KEY unique_external_mapping (integration_id, entity_type, external_id)
);
```

### Mod√®les Eloquent

#### `Integration.php`

**M√©thodes principales :**

```php
// Helpers de synchronisation
public function canSync(): bool
public function needsSync(): bool
public function recordSync(bool $success = true, ?string $error = null): void
public function updateNextSync(): void

// Mapping d'IDs
public function mapIds(string $entityType, $internalId, $externalId, ?array $metadata = null)
public function getExternalId(string $entityType, $internalId): ?string
public function getInternalId(string $entityType, $externalId): ?string

// Statistiques
public function getSuccessRate(): float
public function getTypeName(): string
public function getStatusBadge(): string

// Relations
public function tenant(): BelongsTo
public function logs(): HasMany
public function mappings(): HasMany

// Scopes
public static function scopeActive($query)
public static function scopeForTenant($query, int $tenantId)
public static function scopeByType($query, string $type)
public static function scopeNeedsSync($query)
```

**Accessors/Mutators pour s√©curit√© :**

```php
// Chiffrement automatique des credentials
public function setCredentialsAttribute($value) {
    $this->attributes['credentials'] = $value
        ? json_encode(Crypt::encrypt($value))
        : null;
}

public function getCredentialsAttribute($value) {
    if (!$value) return null;
    try {
        return Crypt::decrypt(json_decode($value, true));
    } catch (\Exception $e) {
        return null;
    }
}
```

#### `IntegrationLog.php`

**M√©thodes principales :**

```php
// Cr√©ation de log
public static function createLog(int $integrationId, int $tenantId, array $data): self

// Scopes
public static function scopeForIntegration($query, int $integrationId)
public static function scopeForTenant($query, int $tenantId)
public static function scopeByEntityType($query, string $entityType)
public static function scopeSuccessful($query)
public static function scopeFailed($query)
public static function scopeRecent($query, int $hours = 24)

// Helpers
public function getStatusBadge(): string
public function wasSuccessful(): bool
```

#### `IntegrationMapping.php`

**M√©thodes principales :**

```php
// Scopes
public static function scopeForIntegration($query, int $integrationId)
public static function scopeForTenant($query, int $tenantId)
public static function scopeByEntityType($query, string $entityType)
public static function scopeRecentlySynced($query, int $hours = 24)

// Helpers
public function needsSync(int $hours = 24): bool
public function markSynced(): void
```

---

## üì¶ Installation et configuration

### 1. Ex√©cuter la migration

```bash
"C:\wamp64\bin\php\php8.1.0\php.exe" artisan migrate
```

Cette commande cr√©era les 3 tables : `integrations`, `integration_logs`, `integration_mappings`.

### 2. Configuration des permissions

Assurez-vous que les utilisateurs admin/grossiste ont acc√®s aux routes :

```php
// Dans routes/web.php - d√©j√† configur√©
Route::middleware(['auth', 'role:grossiste'])->prefix('admin')->name('admin.')->group(function () {
    Route::prefix('integrations')->name('integrations.')->group(function () {
        // 11 routes disponibles
    });
});
```

### 3. V√©rifier le menu navigation

Le menu "Int√©grations ERP" doit appara√Ætre dans le sidebar admin :

```blade
<li class="nav-item">
    <a class="nav-link {{ request()->routeIs('admin.integrations.*') ? 'active' : '' }}"
       href="{{ route('admin.integrations.index') }}">
        <i class="fas fa-plug"></i>
        Int√©grations ERP
    </a>
</li>
```

### 4. Configuration Laravel Scheduler (optionnel)

Pour la synchronisation automatique, configurer le cron :

```bash
# Dans crontab (Linux/Mac) ou Task Scheduler (Windows)
* * * * * cd /path-to-project && php artisan schedule:run >> /dev/null 2>&1
```

Cr√©er la commande de synchronisation :

```bash
"C:\wamp64\bin\php\php8.1.0\php.exe" artisan make:command SyncIntegrations
```

---

## üìñ Guide d'utilisation

### Acc√®s √† l'interface

**URL :** `http://127.0.0.1:8001/admin/integrations`

**Permissions requises :** R√¥le `grossiste` (admin tenant)

### Cr√©er une nouvelle int√©gration

1. **Acc√©der √†** `/admin/integrations`
2. **Cliquer sur** "Nouvelle Int√©gration"
3. **Remplir le formulaire :**
   - **Nom** : Ex. "Synchronisation SAP Production"
   - **Type** : S√©lectionner l'ERP (SAP B1, Dynamics, etc.)
   - **Direction** : Export, Import ou Bidirectionnel
   - **Fr√©quence** : Manuel, Horaire, Quotidien, Hebdomadaire
   - **Entit√©s** : Cocher Produits, Commandes, Clients, Factures, Inventaire
   - **Credentials** : Saisir les informations d'authentification
   - **Settings** : Configuration sp√©cifique (URL API, etc.)

4. **Sauvegarder** - L'int√©gration est cr√©√©e avec statut `inactive`

### Tester la connexion

1. **Localiser l'int√©gration** dans la liste
2. **Cliquer sur l'ic√¥ne** üß™ (Test)
3. **V√©rifier le r√©sultat** :
   - ‚úÖ **Succ√®s** : Temps de r√©ponse affich√©, statut passe √† `testing`
   - ‚ùå **√âchec** : Message d'erreur affich√©, statut passe √† `error`

### Activer l'int√©gration

Une fois le test r√©ussi, activer l'int√©gration :

1. **Cliquer sur le bouton** "Activer" ou modifier le statut
2. Le statut passe √† `active`
3. La synchronisation automatique d√©marrera selon la fr√©quence configur√©e

### Synchronisation manuelle

1. **Cliquer sur l'ic√¥ne** üîÑ (Sync)
2. **Attendre le r√©sultat** :
   - Message de succ√®s avec nombre d'√©l√©ments synchronis√©s
   - Ou message d'erreur avec d√©tails
3. **V√©rifier les logs** pour le d√©tail des op√©rations

### Consulter les logs

1. **Cliquer sur l'ic√¥ne** üëÅÔ∏è (D√©tails)
2. **Acc√©der √† l'onglet "Logs"**
3. **Filtrer par** :
   - Type d'entit√© (produit, commande, etc.)
   - Statut (succ√®s, √©chec)
   - Date
4. **Exporter les logs** si n√©cessaire

### Modifier une int√©gration

1. **Cliquer sur l'ic√¥ne** ‚úèÔ∏è (Modifier)
2. **Mettre √† jour** les champs n√©cessaires
3. **Sauvegarder** - Les changements sont appliqu√©s imm√©diatement

‚ö†Ô∏è **Attention** : Modifier les credentials ou settings peut n√©cessiter un nouveau test de connexion.

### Supprimer une int√©gration

1. **Cliquer sur l'ic√¥ne** üóëÔ∏è (Supprimer)
2. **Confirmer** la suppression
3. **R√©sultat** :
   - L'int√©gration est soft-deleted
   - Les logs et mappings sont conserv√©s pour l'audit
   - La synchronisation automatique est arr√™t√©e

---

## üîå Impl√©mentation par ERP

### 1Ô∏è‚É£ SAP Business One

**Type :** `sap_b1`

**Credentials requises :**
```json
{
    "server": "https://sap-server.company.com",
    "database": "COMPANY_DB",
    "username": "api_user",
    "password": "encrypted_password",
    "company_db": "COMPANY"
}
```

**Endpoints principaux :**
- Login : `/b1s/v1/Login`
- Orders : `/b1s/v1/Orders`
- Items : `/b1s/v1/Items`
- BusinessPartners : `/b1s/v1/BusinessPartners`

**Exemple d'impl√©mentation (√† ajouter dans le controller) :**

```php
private function testSAPConnection($integration)
{
    $credentials = $integration->credentials;

    try {
        $response = Http::post($credentials['server'] . '/b1s/v1/Login', [
            'CompanyDB' => $credentials['database'],
            'UserName' => $credentials['username'],
            'Password' => $credentials['password']
        ]);

        if ($response->successful()) {
            $sessionId = $response->json('SessionId');
            return ['success' => true, 'message' => 'Connexion SAP B1 r√©ussie', 'session' => $sessionId];
        }

        return ['success' => false, 'error' => $response->body()];
    } catch (\Exception $e) {
        return ['success' => false, 'error' => $e->getMessage()];
    }
}

private function syncSAP($integration, $entityType)
{
    $credentials = $integration->credentials;
    $exported = 0;

    // 1. Login et obtenir session
    $loginResponse = $this->testSAPConnection($integration);
    if (!$loginResponse['success']) {
        return ['success' => false, 'error' => $loginResponse['error']];
    }

    $sessionId = $loginResponse['session'];

    // 2. Export des commandes
    if ($entityType === 'all' || $entityType === 'orders') {
        $orders = Order::where('tenant_id', $integration->tenant_id)
            ->whereDoesntHave('integrationMappings', function($q) use ($integration) {
                $q->where('integration_id', $integration->id)
                  ->where('entity_type', 'order');
            })
            ->limit(50)
            ->get();

        foreach ($orders as $order) {
            try {
                $response = Http::withHeaders([
                    'Cookie' => "B1SESSION={$sessionId}",
                    'Content-Type' => 'application/json'
                ])->post($credentials['server'] . '/b1s/v1/Orders', [
                    'CardCode' => $order->user->external_code ?? 'C' . $order->user_id,
                    'DocDate' => $order->created_at->format('Y-m-d'),
                    'DocDueDate' => $order->created_at->addDays(30)->format('Y-m-d'),
                    'DocumentLines' => $order->items->map(function($item) {
                        return [
                            'ItemCode' => $item->product->sku,
                            'Quantity' => $item->quantity,
                            'Price' => $item->price,
                        ];
                    })->toArray()
                ]);

                if ($response->successful()) {
                    $externalId = $response->json('DocEntry');

                    // Mapper l'ID
                    $integration->mapIds('order', $order->id, $externalId);

                    // Logger le succ√®s
                    IntegrationLog::createLog($integration->id, $integration->tenant_id, [
                        'entity_type' => 'order',
                        'entity_id' => $order->id,
                        'external_id' => $externalId,
                        'action' => 'create',
                        'direction' => 'export',
                        'status' => 'success',
                        'request_data' => $response->json(),
                    ]);

                    $exported++;
                } else {
                    // Logger l'√©chec
                    IntegrationLog::createLog($integration->id, $integration->tenant_id, [
                        'entity_type' => 'order',
                        'entity_id' => $order->id,
                        'action' => 'create',
                        'direction' => 'export',
                        'status' => 'failed',
                        'error_message' => $response->body(),
                    ]);
                }
            } catch (\Exception $e) {
                IntegrationLog::createLog($integration->id, $integration->tenant_id, [
                    'entity_type' => 'order',
                    'entity_id' => $order->id,
                    'action' => 'create',
                    'direction' => 'export',
                    'status' => 'failed',
                    'error_message' => $e->getMessage(),
                ]);
            }
        }
    }

    // 3. Logout
    Http::post($credentials['server'] . '/b1s/v1/Logout');

    return ['success' => true, 'message' => "{$exported} commandes export√©es vers SAP B1"];
}
```

**Packages recommand√©s :**
- `composer require guzzlehttp/guzzle` (d√©j√† inclus dans Laravel)

---

### 2Ô∏è‚É£ Microsoft Dynamics 365

**Type :** `dynamics_365`

**Credentials requises :**
```json
{
    "tenant_id": "azure-tenant-id",
    "client_id": "azure-app-id",
    "client_secret": "azure-secret",
    "resource_url": "https://org.crm.dynamics.com",
    "api_version": "v9.2"
}
```

**Authentification OAuth 2.0 :**

```php
private function getDynamicsAccessToken($credentials)
{
    $response = Http::asForm()->post("https://login.microsoftonline.com/{$credentials['tenant_id']}/oauth2/v2.0/token", [
        'client_id' => $credentials['client_id'],
        'client_secret' => $credentials['client_secret'],
        'scope' => $credentials['resource_url'] . '/.default',
        'grant_type' => 'client_credentials'
    ]);

    return $response->json('access_token');
}

private function syncDynamics($integration, $entityType)
{
    $credentials = $integration->credentials;
    $token = $this->getDynamicsAccessToken($credentials);

    // Export commandes
    if ($entityType === 'all' || $entityType === 'orders') {
        $orders = Order::where('tenant_id', $integration->tenant_id)
            ->whereDoesntHave('integrationMappings', function($q) use ($integration) {
                $q->where('integration_id', $integration->id);
            })
            ->limit(50)
            ->get();

        foreach ($orders as $order) {
            $response = Http::withToken($token)->post(
                "{$credentials['resource_url']}/api/data/{$credentials['api_version']}/salesorders",
                [
                    'name' => "Order #{$order->id}",
                    'ordernumber' => $order->order_number,
                    'totalamount' => $order->total_amount,
                    // ... autres champs
                ]
            );

            if ($response->successful()) {
                $integration->mapIds('order', $order->id, $response->json('salesorderid'));
            }
        }
    }

    return ['success' => true, 'message' => 'Synchronisation Dynamics 365 r√©ussie'];
}
```

---

### 3Ô∏è‚É£ Sage Accounting

**Type :** `sage`

**Credentials requises :**
```json
{
    "client_id": "sage-app-id",
    "client_secret": "sage-secret",
    "refresh_token": "user-refresh-token",
    "region": "eu"
}
```

**API Endpoints :**
- Base URL : `https://api.accounting.sage.com/v3.1`
- Products : `/products`
- Invoices : `/sales_invoices`
- Contacts : `/contacts`

---

### 4Ô∏è‚É£ QuickBooks Online

**Type :** `quickbooks`

**Credentials requises :**
```json
{
    "realm_id": "company-id",
    "client_id": "intuit-app-id",
    "client_secret": "intuit-secret",
    "access_token": "oauth-access-token",
    "refresh_token": "oauth-refresh-token",
    "sandbox": false
}
```

**Exemple :**

```php
private function syncQuickBooks($integration, $entityType)
{
    $credentials = $integration->credentials;
    $baseUrl = $credentials['sandbox']
        ? 'https://sandbox-quickbooks.api.intuit.com'
        : 'https://quickbooks.api.intuit.com';

    if ($entityType === 'all' || $entityType === 'invoices') {
        $orders = Order::where('tenant_id', $integration->tenant_id)
            ->where('status', 'completed')
            ->limit(50)
            ->get();

        foreach ($orders as $order) {
            $response = Http::withHeaders([
                'Authorization' => 'Bearer ' . $credentials['access_token'],
                'Accept' => 'application/json',
                'Content-Type' => 'application/json'
            ])->post("{$baseUrl}/v3/company/{$credentials['realm_id']}/invoice", [
                'CustomerRef' => ['value' => $order->user->quickbooks_id ?? '1'],
                'Line' => $order->items->map(function($item) {
                    return [
                        'Amount' => $item->quantity * $item->price,
                        'DetailType' => 'SalesItemLineDetail',
                        'SalesItemLineDetail' => [
                            'ItemRef' => ['value' => $item->product->quickbooks_id ?? '1'],
                            'Qty' => $item->quantity,
                            'UnitPrice' => $item->price
                        ]
                    ];
                })->toArray()
            ]);

            if ($response->successful()) {
                $integration->mapIds('invoice', $order->id, $response->json('Invoice.Id'));
            }
        }
    }

    return ['success' => true, 'message' => 'Synchronisation QuickBooks r√©ussie'];
}
```

---

### 5Ô∏è‚É£ Odoo ERP

**Type :** `odoo`

**Credentials requises :**
```json
{
    "url": "https://mycompany.odoo.com",
    "database": "mycompany",
    "username": "admin@company.com",
    "api_key": "api-key-or-password"
}
```

**Authentification XML-RPC :**

```php
private function syncOdoo($integration, $entityType)
{
    $credentials = $integration->credentials;

    // Connexion XML-RPC
    $commonClient = new \Laminas\XmlRpc\Client($credentials['url'] . '/xmlrpc/2/common');
    $uid = $commonClient->call('authenticate', [
        $credentials['database'],
        $credentials['username'],
        $credentials['api_key'],
        []
    ]);

    $models = new \Laminas\XmlRpc\Client($credentials['url'] . '/xmlrpc/2/object');

    // Export produits vers Odoo
    if ($entityType === 'all' || $entityType === 'products') {
        $products = Product::where('tenant_id', $integration->tenant_id)->limit(50)->get();

        foreach ($products as $product) {
            $productId = $models->call('execute_kw', [
                $credentials['database'],
                $uid,
                $credentials['api_key'],
                'product.template',
                'create',
                [[
                    'name' => $product->name,
                    'default_code' => $product->sku,
                    'list_price' => $product->price,
                    'type' => 'product'
                ]]
            ]);

            $integration->mapIds('product', $product->id, $productId);
        }
    }

    return ['success' => true, 'message' => 'Synchronisation Odoo r√©ussie'];
}
```

**Package requis :**
```bash
composer require laminas/laminas-xmlrpc
```

---

### 6Ô∏è‚É£ Xero Accounting

**Type :** `xero`

**Credentials requises :**
```json
{
    "client_id": "xero-app-id",
    "client_secret": "xero-secret",
    "tenant_id": "xero-tenant-id",
    "access_token": "oauth-token",
    "refresh_token": "refresh-token"
}
```

**Package recommand√© :**
```bash
composer require xeroapi/xero-php-oauth2
```

---

### 7Ô∏è‚É£ Oracle NetSuite

**Type :** `netsuite`

**Credentials requises :**
```json
{
    "account_id": "123456",
    "consumer_key": "consumer-key",
    "consumer_secret": "consumer-secret",
    "token_id": "token-id",
    "token_secret": "token-secret",
    "rest_url": "https://123456.suitetalk.api.netsuite.com/services/rest"
}
```

---

### 8Ô∏è‚É£ Custom API

**Type :** `custom_api`

**Settings requises :**
```json
{
    "api_url": "https://api.myerp.com",
    "api_key": "custom-api-key",
    "endpoints": {
        "orders": "/api/orders",
        "products": "/api/products",
        "customers": "/api/customers"
    }
}
```

**Exemple d'impl√©mentation :**

```php
private function testCustomAPIConnection($integration)
{
    $settings = $integration->settings ?? [];
    $apiUrl = $settings['api_url'] ?? null;

    if (!$apiUrl) {
        return ['success' => false, 'error' => 'URL API manquante'];
    }

    try {
        $response = Http::timeout(10)
            ->withHeaders(['X-API-Key' => $settings['api_key'] ?? ''])
            ->get($apiUrl . '/health');

        if ($response->successful()) {
            return ['success' => true, 'message' => 'API accessible'];
        }

        return ['success' => false, 'error' => 'HTTP ' . $response->status()];
    } catch (\Exception $e) {
        return ['success' => false, 'error' => $e->getMessage()];
    }
}

private function syncCustomAPI($integration, $entityType)
{
    $settings = $integration->settings;
    $apiUrl = $settings['api_url'];
    $apiKey = $settings['api_key'];

    if ($entityType === 'all' || $entityType === 'orders') {
        $orders = Order::where('tenant_id', $integration->tenant_id)->limit(50)->get();

        foreach ($orders as $order) {
            $response = Http::withHeaders(['X-API-Key' => $apiKey])
                ->post($apiUrl . $settings['endpoints']['orders'], [
                    'order_number' => $order->order_number,
                    'customer_email' => $order->user->email,
                    'total' => $order->total_amount,
                    'items' => $order->items->map(function($item) {
                        return [
                            'sku' => $item->product->sku,
                            'quantity' => $item->quantity,
                            'price' => $item->price
                        ];
                    })
                ]);

            if ($response->successful()) {
                $integration->mapIds('order', $order->id, $response->json('id'));
            }
        }
    }

    return ['success' => true, 'message' => 'Synchronisation Custom API r√©ussie'];
}
```

---

## üîí S√©curit√©

### Chiffrement des credentials

**Automatique via Laravel Crypt :**

```php
// Lors de la sauvegarde
$integration->credentials = [
    'username' => 'api_user',
    'password' => 'secret123'
];
$integration->save();

// Laravel chiffre automatiquement via le mutator
// Stockage en BDD : {"iv":"...","value":"...","mac":"..."}

// Lors de la lecture
$credentials = $integration->credentials;
// Laravel d√©chiffre automatiquement via l'accessor
// R√©sultat : ['username' => 'api_user', 'password' => 'secret123']
```

### Permissions et autorisation

**Policy IntegrationPolicy (√† cr√©er) :**

```php
<?php

namespace App\Policies;

use App\Models\Integration;
use App\Models\User;

class IntegrationPolicy
{
    public function viewAny(User $user): bool
    {
        return $user->role === 'grossiste';
    }

    public function view(User $user, Integration $integration): bool
    {
        return $user->role === 'grossiste'
            && $user->tenant_id === $integration->tenant_id;
    }

    public function create(User $user): bool
    {
        return $user->role === 'grossiste';
    }

    public function update(User $user, Integration $integration): bool
    {
        return $user->role === 'grossiste'
            && $user->tenant_id === $integration->tenant_id;
    }

    public function delete(User $user, Integration $integration): bool
    {
        return $user->role === 'grossiste'
            && $user->tenant_id === $integration->tenant_id;
    }
}
```

**Enregistrer la policy :**

```php
// Dans app/Providers/AuthServiceProvider.php
protected $policies = [
    Integration::class => IntegrationPolicy::class,
];
```

### Protection CSRF

Toutes les routes POST/PUT/DELETE sont prot√©g√©es par le middleware `web` qui inclut `VerifyCsrfToken`.

### Validation des donn√©es

**Validation stricte dans le controller :**

```php
$validated = $request->validate([
    'name' => 'required|string|max:255',
    'type' => 'required|in:sap_b1,dynamics_365,sage,quickbooks,odoo,xero,netsuite,custom_api',
    'sync_direction' => 'required|in:export,import,bidirectional',
    'sync_frequency' => 'required|in:manual,hourly,daily,weekly',
    'credentials' => 'nullable|array',
    'settings' => 'nullable|array',
]);
```

---

## üìä Monitoring et logs

### Dashboard de statistiques

**M√©triques disponibles :**

```php
$stats = [
    'total_integrations' => Integration::forTenant($tenant_id)->count(),
    'active_integrations' => Integration::forTenant($tenant_id)->active()->count(),
    'total_syncs' => $integrations->sum('total_syncs'),
    'success_rate' => $integrations->avg('successful_syncs') / max($integrations->avg('total_syncs'), 1) * 100
];
```

### Consultation des logs

**Filtrage avanc√© :**

```php
$logs = IntegrationLog::forIntegration($integrationId)
    ->byEntityType('order')
    ->failed()
    ->recent(48) // 48 derni√®res heures
    ->paginate(100);
```

### Alertes automatiques

**Exemple de d√©tection d'erreurs r√©p√©t√©es :**

```php
public function checkIntegrationHealth()
{
    $problematicIntegrations = Integration::active()
        ->where('failed_syncs', '>', 5)
        ->where('last_sync_at', '>=', now()->subHours(24))
        ->get();

    foreach ($problematicIntegrations as $integration) {
        // Envoyer notification admin
        Notification::send(
            $integration->tenant->admins,
            new IntegrationFailureAlert($integration)
        );

        // D√©sactiver automatiquement si trop d'√©checs
        if ($integration->failed_syncs > 10) {
            $integration->update(['status' => 'error']);
        }
    }
}
```

### M√©triques de performance

**Analyse des dur√©es de synchronisation :**

```php
$avgDuration = IntegrationLog::forIntegration($integrationId)
    ->successful()
    ->recent(168) // 7 jours
    ->avg('duration_ms');

$slowSyncs = IntegrationLog::forIntegration($integrationId)
    ->where('duration_ms', '>', 5000) // Plus de 5 secondes
    ->latest()
    ->limit(10)
    ->get();
```

---

## üîß D√©pannage

### Probl√®me : Connexion √©choue syst√©matiquement

**Solutions :**

1. **V√©rifier les credentials :**
   ```php
   $credentials = $integration->credentials;
   dd($credentials); // V√©rifier le d√©chiffrement
   ```

2. **Tester manuellement l'API :**
   ```bash
   curl -X POST https://api.erp.com/login \
     -H "Content-Type: application/json" \
     -d '{"username":"test","password":"test"}'
   ```

3. **V√©rifier les logs Laravel :**
   ```bash
   tail -f storage/logs/laravel.log
   ```

4. **D√©sactiver temporairement le SSL (dev uniquement) :**
   ```php
   Http::withoutVerifying()->get($url);
   ```

### Probl√®me : Synchronisation partielle

**Causes possibles :**
- Timeout r√©seau
- Limite de requ√™tes API (rate limiting)
- Donn√©es invalides dans certains enregistrements

**Solutions :**

1. **Augmenter le timeout :**
   ```php
   Http::timeout(60)->post($url, $data);
   ```

2. **Ajouter retry avec backoff :**
   ```php
   Http::retry(3, 100)->post($url, $data);
   ```

3. **Synchroniser par lots plus petits :**
   ```php
   $orders = Order::where('tenant_id', $tenant_id)
       ->limit(10) // R√©duire de 50 √† 10
       ->get();
   ```

### Probl√®me : Credentials non d√©chiffr√©s

**Cause :** Changement de `APP_KEY` Laravel

**Solution :**
1. **NE JAMAIS changer APP_KEY en production**
2. Si n√©cessaire, re-saisir toutes les credentials apr√®s changement de cl√©

### Probl√®me : Mapping d'IDs dupliqu√©s

**Cause :** Violation de contrainte unique

**Solution :**
```php
// V√©rifier avant de cr√©er
$existingMapping = IntegrationMapping::where([
    'integration_id' => $integrationId,
    'entity_type' => 'order',
    'internal_id' => $orderId
])->first();

if ($existingMapping) {
    $existingMapping->update(['external_id' => $newExternalId]);
} else {
    IntegrationMapping::create([...]);
}
```

### Probl√®me : Synchronisation lente

**Optimisations :**

1. **Utiliser eager loading :**
   ```php
   $orders = Order::with(['items.product', 'user'])
       ->where('tenant_id', $tenant_id)
       ->get();
   ```

2. **Traitement asynchrone avec queues :**
   ```php
   dispatch(new SyncIntegrationJob($integration, $entityType));
   ```

3. **Pagination pour gros volumes :**
   ```php
   Order::chunk(100, function ($orders) use ($integration) {
       // Synchroniser chaque chunk
   });
   ```

---

## üìû Support et ressources

### Documentation officielle des ERP

- **SAP B1** : https://help.sap.com/docs/SAP_BUSINESS_ONE_SERVICE_LAYER
- **Dynamics 365** : https://learn.microsoft.com/dynamics365/
- **Sage** : https://developer.sage.com/
- **QuickBooks** : https://developer.intuit.com/
- **Odoo** : https://www.odoo.com/documentation/
- **Xero** : https://developer.xero.com/
- **NetSuite** : https://docs.oracle.com/en/cloud/saas/netsuite/

### Logs et debugging

```bash
# Logs Laravel
tail -f storage/logs/laravel.log

# Logs Nginx/Apache
tail -f /var/log/nginx/error.log

# Logs base de donn√©es (MySQL)
tail -f /var/log/mysql/error.log
```

### Commandes artisan utiles

```bash
# Lister toutes les routes
"C:\wamp64\bin\php\php8.1.0\php.exe" artisan route:list --name=integrations

# Vider le cache
"C:\wamp64\bin\php\php8.1.0\php.exe" artisan cache:clear

# Tester une int√©gration via tinker
"C:\wamp64\bin\php\php8.1.0\php.exe" artisan tinker
>>> $integration = Integration::find(1);
>>> $integration->canSync();
```

---

## ‚úÖ Checklist de mise en production

- [ ] Migration ex√©cut√©e sur serveur de production
- [ ] Credentials chiffr√©es test√©es et valid√©es
- [ ] Tests de connexion r√©ussis pour chaque ERP configur√©
- [ ] Logs de synchronisation v√©rifi√©s (aucune erreur critique)
- [ ] Scheduler Laravel configur√© (cron)
- [ ] Alertes email configur√©es pour √©checs
- [ ] Policy d'autorisation activ√©e
- [ ] Sauvegarde base de donn√©es effectu√©e
- [ ] Documentation API fournie aux d√©veloppeurs
- [ ] Formation utilisateurs admin r√©alis√©e
- [ ] Plan de rollback pr√©par√©

---

**üìÖ Derni√®re mise √† jour :** 06 Octobre 2025
**üìå Version syst√®me :** 1.0.0
**üéØ Statut :** Production Ready (75% - Framework complet, impl√©mentations API √† finaliser)
